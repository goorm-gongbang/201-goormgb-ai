meta:
  project: "Traffic-Master"
  version: "1.0.0"
  stage:
    id: "S2"
    name: "QUEUE"
    description: "대기열 관리 및 트래픽 제어 시스템"
    type: "Polling/Stateful"

# 12. 도메인 모델 정의
domain:
  models:
    QueueTicket:
      fields:
        queueTicketId: "string (UUID)"
        sessionId: "string (UUID)"
        gameId: "string"
        mode:
          type: "enum"
          values: ["RECOMMEND", "MAP"]
        position: "integer"
        initialPosition: "integer"
        status:
          type: "enum"
          values: ["WAITING", "GRANTED", "BLOCKED"]
        estimatedWaitMs: "integer"
        createdAt: "ISODate"

# 13. API 계약 (Polling Contract)
api:
  endpoints:
    - path: "/api/queue/enter"
      method: "POST"
      description: "대기열 진입 요청"
      body:
        sessionId: "uuid"
        gameId: "string"
        mode: "RECOMMEND | MAP"
        preferences: "Preferences Object"
      response:
        queueTicketId: "string"
        position: "integer"
        estimatedWaitMs: "integer"

    - path: "/api/queue/{queueTicketId}"
      method: "GET"
      description: "대기열 상태 폴링"
      response:
        position: "integer"
        progress: "float (0.0 - 1.0)"
        status: "WAITING | GRANTED | BLOCKED"
        nextUrl: "/stage4 | null"

# 14. 상태 전이 규칙 (State Machine)
stateLogic:
  transitions:
    - from: "WAITING"
      to: "GRANTED"
      condition: "elapsedTime >= estimatedWaitMs OR position <= 0"
    - from: "WAITING"
      to: "BLOCKED"
      condition: "Defense Policy Triggered"

# 16. 방어 정책 (Defense Mechanism)
defensePolicies:
  throttling:
    action: "increase estimatedWaitMs"
  sandboxing:
    action: "redirect to isolated queue pool"
  blocking:
    action: "transition to BLOCKED state"

# 15. 이벤트 스키마 확장
telemetry:
  events:
    - "STAGE_2_QUEUE_SHOWN"
    - "QUEUE_POSITION_UPDATED"
    - "QUEUE_ENTRY_GRANTED"
    - "QUEUE_ABORTED"

# 17. 완료 조건 (Definition of Done)
completionCriteria:
  - "QueueTicket Created"
  - "Polling Logic Active"
  - "Transition: GRANTED -> Next Stage (S3 or S4)"
  - "Event Logged"
