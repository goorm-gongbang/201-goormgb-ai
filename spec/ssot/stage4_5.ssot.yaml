meta:
  project: "Traffic-Master"
  version: "1.0.0"
  stage:
    id: "S5"
    name: "SEAT_SELECTION"
    description: "ì¢Œì„ ì¶”ì²œ ë° ë§µ ê¸°ë°˜ ì„ íƒ (Atomic Hold ë³´ì¥ êµ¬ê°„)"
    type: "Hybrid (Data-Driven + Interactive)"

# 25~28, 35~37. ë„ë©”ì¸ ëª¨ë¸ ì •ì˜
domain:
  # ëª¨ë“œ ì •ì˜ (í•„ìˆ˜)
  modes:
    - "RECOMMEND"
    - "MAP"
  
  models:
    SeatMode:
      type: "enum"
      values: ["RECOMMEND", "MAP"]
      constraint: "Must be determined upon Stage 5 entry"

    SeatBundle:
      description: "ì¶”ì²œ ëª¨ë“œì—ì„œ ì‚¬ìš©í•˜ëŠ” ì¢Œì„ ë¬¶ìŒ"
      fields:
        seatBundleId: "string (UUID)"
        gameId: "string"
        seatIds: "string[]"
        sectionLabel: "string"
        rowLabel: "string"
        totalPrice: "money"
        rank: "integer (1|2|3)"

    Zone:
      description: "ë§µ ëª¨ë“œ êµ¬ì—­ ì •ë³´"
      fields:
        zoneId: "string"
        label: "string"
        remaining: "integer"
        disabled: "boolean"

    SeatGrid:
      description: "ë§µ ëª¨ë“œ ê°œë³„ ì¢Œì„ ê·¸ë¦¬ë“œ"
      fields:
        zoneId: "string"
        rows: "integer"
        cols: "integer"
        seats: 
          type: "array"
          items:
            seatId: "string"
            status: "AVAILABLE | HELD_BY_OTHERS | UNAVAILABLE"
            label: "string"

    Hold:
      description: "ì„ì‹œ ì„ ì  ê°ì²´ (ì„œë²„ ìƒíƒœ)"
      fields:
        holdId: "string (UUID)"
        sessionId: "string"
        seatIds: "string[]"
        status: "ACTIVE | EXPIRED | FAILED"
        expiresAt: "ISODate"

# 31 & 38. API ê³„ì•½ (Contract)
api:
  endpoints:
    # ì¶”ì²œ API
    - path: "/api/recommendations"
      method: "GET"
      queryParams: ["gameId", "sessionId", "partySize", "tab"]
      response: "Recommendation[]"

    # ë§µ API
    - path: "/api/zones"
      method: "GET"
      response: "{ zones: Zone[], groups: ZoneGroup[] }"

    - path: "/api/zones/{zoneId}/seats"
      method: "GET"
      response: "ZoneSeatGridResponse"

    # í•µì‹¬: Hold (ê³µí†µ)
    - path: "/api/holds"
      method: "POST"
      description: "ì¢Œì„ ì„ ì  ìš”ì²­ (Atomic)"
      headers:
        Idempotency-Key: "required (UUID v4)"
      body:
        sessionId: "uuid"
        gameId: "string"
        mode: "RECOMMEND | MAP"
        target: 
          seatBundleId: "string (optional)"
          seatIds: "string[] (required)"
      response:
        holdId: "string"
        status: "SUCCESS | FAIL"
        expiresAt: "ISODate"
        reason: "null | HELD_BY_OTHERS | SOLD_OUT | ALREADY_HAS_ACTIVE_HOLD"

    # ì£¼ë¬¸ì„œ ì´ë™
    - path: "/api/orders"
      method: "POST"
      body:
        holdId: "string (required)"
      response: "OrderToken"

# 30 & 39. UI ìƒíƒœ ë° ë¡œì§ (State Machine)
uiLogic:
  states:
    RECOMMEND_VIEW:
      on:
        REFRESH: "Reload Recommendations"
        SELECT: "Hold Submitting..."
    
    MAP_ZONE_VIEW:
      on:
        SELECT_ZONE: "Transition to SEAT_VIEW"
    
    MAP_SEAT_VIEW:
      on:
        SELECT_SEAT: "Update Local Selection (Client Only)"
        SUBMIT: "Hold Submitting... (Only if count == partySize)"

  # ğŸ”¥ í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ (ë°˜ë“œì‹œ êµ¬í˜„ë˜ì–´ì•¼ í•¨)
  consistencyGuarantees:
    atomicity:
      rule: "All-or-Nothing"
      description: "ìš”ì²­ëœ seatIds ì¤‘ í•˜ë‚˜ë¼ë„ ì„ ì  ë¶ˆê°€ ì‹œ ì „ì²´ ì‹¤íŒ¨ ì²˜ë¦¬"
    
    idempotency:
      rule: "Strict Key Check"
      description: "Idempotency-Key ëˆ„ë½ ì‹œ 400 Bad Request. ë™ì¼ Key ì¬ìš”ì²­ ì‹œ ìºì‹œëœ ê²°ê³¼ ë°˜í™˜."
    
    concurrency:
      rule: "Single Active Hold"
      description: "Sessionë‹¹ Active HoldëŠ” ë‹¨ 1ê°œë§Œ í—ˆìš©. ê¸°ì¡´ Holdê°€ ìˆë‹¤ë©´ ì‹ ê·œ ìš”ì²­ ê±°ë¶€."
    
    stateSeparation:
      rule: "UI != Server"
      description: "UIì—ì„œì˜ ì„ íƒ(Click)ì€ ì„œë²„ì˜ Hold ìƒíƒœì™€ ë¬´ê´€í•¨. ì˜¤ì§ API ì„±ê³µë§Œì´ ìì›ì„ í™•ë³´í•¨."

# 32 & 40. ì´ë²¤íŠ¸ ë° ë¡œê¹… (Telemetry)
telemetry:
  events:
    # ê³µí†µ
    - name: "STAGE_5_VIEWED"
      payload: { mode: "RECOMMEND | MAP" }
    - name: "BOOKING_CLICKED_STAGE5"
      payload: { mode: "string", seatCount: "number" }
    
    # ì¶”ì²œ ëª¨ë“œ
    - "RECOMMEND_TAB_CHANGED"
    - "RECOMMEND_REFRESH_CLICKED"
    - "RECOMMEND_CARD_SELECTED"
    - "AUTO_SELECT_CLICKED"
    
    # ë§µ ëª¨ë“œ
    - "ZONE_SELECTED"
    - "SEAT_CLICKED"
    - "SEAT_SELECTED"
    - "SEAT_DESELECTED"
    
    # Hold ê²°ê³¼ (ê°€ì¥ ì¤‘ìš”)
    - name: "HOLD_REQUESTED"
      payload: { idempotencyKey: "string", seatIds: "[]" }
    - name: "HOLD_SUCCEEDED"
      payload: { holdId: "string" }
    - name: "HOLD_FAILED"
      payload: { reason: "HELD_BY_OTHERS | ..." }

# 33. ë°©ì–´ ë° ë¦¬ìŠ¤í¬ ê´€ë¦¬
riskControl:
  indicators:
    - "High frequency of RECOMMEND_REFRESH"
    - "Rapid Tab Switching"
    - "Repetitive Auto-Select"
    - "Consecutive HOLD_FAILED"
  actions:
    - "Inject CAPTCHA (Stage 3)"
    - "Temporary Session Block"

# 34. ì™„ë£Œ ì¡°ê±´ (Definition of Done)
completionCriteria:
  - "Mode (Recommend/Map) Logic Operational"
  - "Atomic Hold Verified (Test Case Required)"
  - "Idempotency Logic Verified"
  - "Fail Modal with Reason Code implemented"
  - "Transition to Order Page (with valid Hold)"
