meta:
  project: "Traffic-Master"
  version: "1.0.0"
  stage:
    id: "S6"
    name: "PAYMENT"
    description: "ê²°ì œ ì²˜ë¦¬ ë° ì£¼ë¬¸ í™•ì • (Transaction Finalization)"
    type: "Transactional"

# 41 ~ 43. ë„ë©”ì¸ ëª¨ë¸ ì •ì˜
domain:
  models:
    Order:
      description: "ê²°ì œ ëŒ€ê¸° ì¤‘ì¸ ì£¼ë¬¸ì„œ"
      fields:
        orderId: "string (UUID)"
        sessionId: "string"
        gameId: "string"
        seats:
          type: "array"
          items: { grade: "string", label: "string", seatId: "string" }
        amount:
          type: "object"
          properties: { ticket: "number", fee: "number", discount: "number", total: "number" }
        tax:
          type: "object"
          properties: { maskedPhone: "string" }
        status:
          type: "enum"
          values: ["ACTIVE", "EXPIRED", "PAID", "CANCELLED"]
        expiresAt: "ISODate"
        
      # ðŸ”¥ ìœ„í—˜ D í•´ê²°: TTL ë™ê¸°í™” ê·œì¹™
      constraints:
        ttlSync: "Order.expiresAt MUST match or be strictly within Hold.expiresAt"

    Payment:
      description: "ê²°ì œ ì‹œë„ ë° ê²°ê³¼ ë ˆì½”ë“œ"
      fields:
        paymentId: "string (UUID)"
        orderId: "string"
        method:
          type: "enum"
          values: ["TOSS", "KAKAO", "PAYCO", "OTHER"]
        status:
          type: "enum"
          values: ["SUCCEEDED", "FAILED"]
        reasonCode:
          type: "enum"
          values: ["TIMEOUT", "DECLINED", "EXPIRED", "ALREADY_PAID"]
        createdAt: "ISODate"

# 44. API ê³„ì•½ (Contract)
api:
  endpoints:
    # ì£¼ë¬¸ì„œ ì¡°íšŒ
    - path: "/api/orders/{orderId}"
      method: "GET"
      response: "Order (ViewModel)"

    # í˜„ê¸ˆì˜ìˆ˜ì¦ ë²ˆí˜¸ ì—…ë°ì´íŠ¸
    - path: "/api/orders/{orderId}/tax"
      method: "PATCH"
      body: { phone: "string" }
      response: { maskedPhone: "string" }

    # ê²°ì œ ì‹¤í–‰ (í•µì‹¬)
    - path: "/api/payments"
      method: "POST"
      description: "PGì‚¬ ê²°ì œ ìŠ¹ì¸ ë° ì£¼ë¬¸ ìƒíƒœ ë³€ê²½ ìš”ì²­"
      headers:
        Idempotency-Key: "required (UUID v4)" # ðŸ”¥ ìœ„í—˜ B í•´ê²°
      body:
        orderId: "string"
        method: "TOSS | KAKAO | PAYCO | OTHER"
        agreeTerms: "boolean"
        agreeCancelFee: "boolean"
      response:
        success: { result: "OK", paymentId: "string", nextUrl: "string" }
        fail: { result: "FAIL", reasonCode: "string" }

    # ê²°ì œ ì·¨ì†Œ (ëª…ì‹œì  í¬ê¸°) - ðŸ”¥ ìœ„í—˜ E í•´ê²°
    - path: "/api/orders/{orderId}/cancel"
      method: "POST"
      description: "ì‚¬ìš©ìžê°€ ê²°ì œì°½ì—ì„œ 'ì·¨ì†Œ' í´ë¦­ ì‹œ í˜¸ì¶œ. ì¦‰ì‹œ Hold í•´ì œ."
      response: { status: "CANCELLED" }

# 45. ìƒíƒœ ì „ì´ ë° ë¡œì§ (State Machine)
stateLogic:
  orderStates:
    ACTIVE:
      allow: ["PAYMENT_ATTEMPT", "CANCEL", "EXPIRE"]
    PAID:
      allow: [] # Final State
    EXPIRED:
      allow: [] # Final State (Payment Attempt Blocked)
    CANCELLED:
      allow: [] # Final State (Hold Released)

  # ðŸ”¥ í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ (êµ¬í˜„ í•„ìˆ˜)
  consistencyGuarantees:
    serverSideValidation: # ðŸ”¥ ìœ„í—˜ A í•´ê²°
      rule: "Trust Server Time Only"
      description: "í”„ë¡ íŠ¸ì—”ë“œ íƒ€ì´ë¨¸ëŠ” UXì¼ ë¿ìž„. ê²°ì œ ìš”ì²­ ì‹œ ì„œë²„ì˜ í˜„ìž¬ ì‹œê°„ > expiresAtì´ë©´ ë¬´ì¡°ê±´ EXPIRED ë¦¬í„´."
    
    idempotency: # ðŸ”¥ ìœ„í—˜ B í•´ê²°
      rule: "Strict Payment Idempotency"
      description: "ë™ì¼ Idempotency-Keyë¡œ ìž¬ìš”ì²­ ì‹œ, ì‹¤ì œ ê²°ì œ ë¡œì§ì„ ë‹¤ì‹œ íƒœìš°ì§€ ì•Šê³  ì €ìž¥ëœ Payment ê²°ê³¼ë¥¼ ë°˜í™˜."
    
    stateFinality: # ðŸ”¥ ìœ„í—˜ C í•´ê²°
      rule: "PAID is Immutable"
      description: "ì´ë¯¸ PAID ìƒíƒœì¸ Orderì— ëŒ€í•´ ì¶”ê°€ ê²°ì œ ì‹œë„ëŠ” í—ˆìš©í•˜ì§€ ì•ŠìŒ (ALREADY_PAID ì—ëŸ¬ ë°˜í™˜)."
    
    cancelPolicy: # ðŸ”¥ ìœ„í—˜ E í•´ê²°
      rule: "Explicit Release"
      description: "Cancel ìš”ì²­ ì‹œ Order ìƒíƒœë¥¼ CANCELLEDë¡œ ë³€ê²½í•˜ê³ , ì—°ê²°ëœ Seat Holdë¥¼ ì¦‰ì‹œ í•´ì œ(Release)í•œë‹¤."

# 46. ì´ë²¤íŠ¸ ë° ë¡œê¹… (Telemetry)
telemetry:
  events:
    - "PAYMENT_PAGE_VIEWED"
    - "PAYMENT_METHOD_SELECTED"
    - "TAX_DEDUCTION_PHONE_UPDATED"
    - "TERMS_AGREED_TOGGLED"
    - "CANCEL_FEE_AGREED_TOGGLED"
    # ì¤‘ìš” íŠ¸ëžœìž­ì…˜ ì´ë²¤íŠ¸
    - name: "PAYMENT_SUBMITTED"
      payload: { idempotencyKey: "string", amount: "number" }
    - name: "PAYMENT_SUCCEEDED"
      payload: { paymentId: "string", orderId: "string" }
    - name: "PAYMENT_FAILED"
      payload: { reason: "TIMEOUT | DECLINED | EXPIRED" }
    - name: "ORDER_EXPIRED_SERVER" # ì„œë²„ê°€ ë§Œë£Œ ì²˜ë¦¬í–ˆì„ ë•Œ
    - name: "ORDER_CANCELLED_USER" # ìœ ì €ê°€ ì·¨ì†Œí–ˆì„ ë•Œ

# ì™„ë£Œ ì¡°ê±´ (Definition of Done)
completionCriteria:
  - "Server-side Expiration Check Verified"
  - "Idempotency Key Handling Verified"
  - "Order State Machine Test (Active -> Paid/Expired/Cancelled)"
  - "Hold Release on Cancel/Expire Verified"
  - "Payment Gateway Mock Integration"
